<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Orbital – Submit PIREP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="icon" href="favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="app">

  <!-- SIDEBAR -->
  <nav class="sidebar">
    <h2>ORBITAL</h2>
    <a href="home.html"><i class="fas fa-chart-line"></i> Dashboard</a>
    <a href="submit-pirep.html"><i class="fas fa-plane-departure"></i> Submit PIREP</a>
    <a href="va/orbital/orbital-events.html"><i class="fas fa-calendar-alt"></i> VA Events</a>
    <a href="va/orbital/orbital-routes.html"><i class="fas fa-route"></i> Available Routes</a>
  </nav>

  <!-- MAIN -->
  <main class="main">

    <h1>Submit New Flight</h1>

    <!-- SEARCH -->
    <input type="text" id="searchFlights" placeholder="Search flights..." class="search-input">

    <!-- FLIGHTS TABLE -->
    <table id="flightsTable">
      <thead>
        <tr>
          <th>Departure</th>
          <th>Destination</th>
          <th>Duration</th>
          <th>Grade Requirement</th>
          <th>Aircraft</th>
          <th>Livery</th>
          <th>Type</th>
        </tr>
      </thead>
      <tbody>
        <!-- Exemple de vols -->
        <tr>
          <td>JFK</td><td>LAX</td><td>6h</td><td>FO</td><td>B738</td><td>Orbital</td><td>Passenger</td>
        </tr>
        <tr>
          <td>LHR</td><td>CDG</td><td>1h30</td><td>FO</td><td>A320</td><td>Orbital</td><td>Passenger</td>
        </tr>
        <tr>
          <td>SFO</td><td>SEA</td><td>2h</td><td>FO</td><td>B738</td><td>Orbital</td><td>Cargo</td>
        </tr>
      </tbody>
    </table>

    <!-- NOTES -->
    <textarea id="notes" placeholder="Optional notes..." rows="4" style="width:100%; margin-top:15px;"></textarea>

    <button class="primary" style="margin-top:15px;" onclick="submitPirep()">
      <i class="fas fa-paper-plane"></i> Submit PIREP
    </button>

  </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
  getFirestore, 
  doc, 
  getDoc, 
  updateDoc, 
  increment,
  addDoc,
  collection,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA-KQGhyjrVhcstiQfqKcDQkiJjQQXf19M",
  authDomain: "orbital---va-manager.firebaseapp.com",
  projectId: "orbital---va-manager",
  storageBucket: "orbital---va-manager.firebasestorage.app",
  messagingSenderId: "162057702983",
  appId: "1:162057702983:web:f8ed3f5d115c7c53cbeb62"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let currentUserData = null;

onAuthStateChanged(auth, async user => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  currentUser = user;
  const snap = await getDoc(doc(db, "users", user.uid));
  currentUserData = snap.data();
});

// ===== SELECT FLIGHT ROW =====
const flightsTable = document.getElementById("flightsTable").tBodies[0];
let selectedRow = null;

Array.from(flightsTable.rows).forEach(row => {
  row.addEventListener("click", () => {
    if (selectedRow) selectedRow.classList.remove("selected");
    row.classList.add("selected");
    selectedRow = row;
  });
});

// ===== SUBMIT PIREP =====
window.submitPirep = async () => {
  if (!selectedRow) {
    alert("Please select a flight");
    return;
  }

  if (!currentUser || !currentUserData) {
    alert("User not loaded");
    return;
  }

  const departure = selectedRow.cells[0].innerText;
  const destination = selectedRow.cells[1].innerText;
  const duration = selectedRow.cells[2].innerText;
  const va = currentUserData.va || "unknown";

  try {
    // 1️⃣ Increment PIREPs counter
    const userRef = doc(db, "users", currentUser.uid);
    await updateDoc(userRef, {
      pireps: increment(1)
    });

    // 2️⃣ Create PIREP log
    await addDoc(collection(db, "pireps"), {
      uid: currentUser.uid,
      departure,
      destination,
      duration,
      va,
      createdAt: serverTimestamp()
    });

    alert("Your flight has been recorded!");

    selectedRow.classList.remove("selected");
    selectedRow = null;
    document.getElementById("notes").value = "";

  } catch (err) {
    console.error("Error submitting PIREP:", err);
    alert("Failed to submit flight.");
  }
};

// ===== SEARCH =====
document.getElementById("searchFlights").addEventListener("keyup", e => {
  const filter = e.target.value.toLowerCase();
  Array.from(flightsTable.rows).forEach(row => {
    row.style.display = Array.from(row.cells)
      .some(td => td.textContent.toLowerCase().includes(filter))
      ? ""
      : "none";
  });
});

// ===== SORT =====
Array.from(flightsTable.tHead.rows[0].cells).forEach((th, i) => {
  th.style.cursor = "pointer";
  th.addEventListener("click", () => {
    const rows = Array.from(flightsTable.rows);
    const asc = !th.asc;
    th.asc = asc;
    rows.sort((a, b) => {
      const aText = a.cells[i].textContent.trim();
      const bText = b.cells[i].textContent.trim();
      return asc
        ? aText.localeCompare(bText)
        : bText.localeCompare(aText);
    });
    rows.forEach(r => flightsTable.appendChild(r));
  });
});
</script>

<style>
/* Ligne sélectionnée */
.selected { background-color: #3c6fdc33; font-weight:bold; cursor:pointer; }
#flightsTable tr:hover { background-color: #3c6fdc22; cursor:pointer; }
.search-input { width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc; }
</style>

</body>
</html>


